# 認証フローの図解

このドキュメントでは、ECサイトにおけるユーザー認証の流れを図解します。

## 目次

1. [ユーザー登録フロー](#ユーザー登録フロー)
2. [ログインフロー](#ログインフロー)
3. [ログアウトフロー](#ログアウトフロー)
4. [アプリケーション起動時の認証チェック](#アプリケーション起動時の認証チェック)
5. [JWT認証の全体像](#jwt認証の全体像)

## ユーザー登録フロー

```mermaid
sequenceDiagram
    actor ユーザー
    participant フロントエンド as Next.js フロントエンド
    participant バックエンド as Rails バックエンド
    participant DB as データベース
    
    ユーザー->>フロントエンド: 登録情報を入力
    フロントエンド->>バックエンド: POST /api/v1/signup
    バックエンド->>DB: ユーザー情報を保存
    DB-->>バックエンド: 保存成功
    バックエンド->>バックエンド: JWTトークン生成
    バックエンド-->>フロントエンド: ユーザー情報とトークン
    フロントエンド->>フロントエンド: トークンをlocalStorageに保存
    フロントエンド->>フロントエンド: AuthContextにユーザー情報を設定
    フロントエンド-->>ユーザー: 登録完了・ログイン状態に
```

## ログインフロー

```mermaid
sequenceDiagram
    actor ユーザー
    participant フロントエンド as Next.js フロントエンド
    participant バックエンド as Rails バックエンド
    participant DB as データベース
    
    ユーザー->>フロントエンド: メールアドレス・パスワードを入力
    フロントエンド->>バックエンド: POST /api/v1/login
    バックエンド->>DB: ユーザー情報を検索
    DB-->>バックエンド: ユーザー情報
    バックエンド->>バックエンド: パスワード検証
    バックエンド->>バックエンド: JWTトークン生成
    バックエンド-->>フロントエンド: ユーザー情報とトークン
    フロントエンド->>フロントエンド: トークンをlocalStorageに保存
    フロントエンド->>フロントエンド: AuthContextにユーザー情報を設定
    フロントエンド-->>ユーザー: ログイン完了
```

## ログアウトフロー

```mermaid
sequenceDiagram
    actor ユーザー
    participant フロントエンド as Next.js フロントエンド
    participant バックエンド as Rails バックエンド
    participant DB as データベース
    
    ユーザー->>フロントエンド: ログアウトボタンをクリック
    フロントエンド->>バックエンド: DELETE /api/v1/logout
    バックエンド->>DB: ユーザーのJTIを更新（トークン無効化）
    DB-->>バックエンド: 更新成功
    バックエンド-->>フロントエンド: ログアウト成功レスポンス
    フロントエンド->>フロントエンド: localStorageからトークンを削除
    フロントエンド->>フロントエンド: AuthContextのユーザー情報をクリア
    フロントエンド-->>ユーザー: ログアウト完了
```

## アプリケーション起動時の認証チェック

```mermaid
flowchart TD
    A[アプリ起動] --> B{localStorageにトークンがある?}
    B -->|はい| C[バックエンドに現在のユーザー情報を問い合わせ]
    B -->|いいえ| D[未ログイン状態で表示]
    C --> E{APIレスポンスは成功?}
    E -->|はい| F[ユーザー情報をAuthContextに設定]
    E -->|いいえ| G[トークンを削除]
    F --> H[ログイン状態で表示]
    G --> D
```

## JWT認証の全体像

```mermaid
flowchart LR
    subgraph フロントエンド
    A[ユーザー操作] --> B[API呼び出し]
    B --> C[トークン管理]
    C --> D[認証状態]
    end
    
    subgraph バックエンド
    E[APIエンドポイント] --> F[認証処理]
    F --> G[トークン生成/検証]
    G --> H[データベース操作]
    end
    
    B -->|HTTPリクエスト| E
    E -->|HTTPレスポンス| C
```

## JWT認証の技術的詳細

### JWTとは

JWT（JSON Web Token）は、当事者間で安全に情報を送信するためのコンパクトで自己完結型の方法です。この情報は、デジタル署名されているため、検証および信頼できます。

### JWTの構造

JWTは、ドットで区切られた3つの部分からなる文字列です：

1. **ヘッダー** - トークンのタイプとアルゴリズム
2. **ペイロード** - クレーム（データ）
3. **署名** - トークンの検証に使用

例：`xxxxx.yyyyy.zzzzz`

### JTIによるトークン無効化

JTI（JWT ID）は、トークンに一意の識別子を提供し、そのトークンを無効化する機能を可能にします。

1. ユーザーがログインすると、一意のJTI値がユーザーレコードに保存されます
2. このJTI値がトークンのペイロードに含まれます
3. ユーザーがログアウトすると、データベース内のJTI値が更新されます
4. 古いJTI値を持つトークンは無効と見なされ、認証に失敗します

これにより、ユーザーがログアウトした後でも、以前発行されたトークンが使用できなくなります。
